<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Logi-PS2 — Play!.js</title>
<link rel="icon" href="static/images/logo.png" type="image/jpeg" />
<style>
:root {
    --border-grad: linear-gradient(90deg, white, black) 1;
    --accent: #38f;
}
html, body {
    height: 100%;
    margin: 0;
    font-family: 'Segoe UI','Helvetica Neue',sans-serif;
    background: url('static/images/1567665.png') no-repeat center center fixed;
    background-size: cover;
    color: white;
    overflow-y: scroll;
}
body::-webkit-scrollbar{ width: 8px; }
body::-webkit-scrollbar-track{ background: rgba(0,0,0,0.6); }
body::-webkit-scrollbar-thumb{ background: #555; border-radius:4px; }
body::-webkit-scrollbar-thumb:hover{ background:#888; }

header{ padding: 18px 20px 6px; text-align:center; }
.page-title{ margin:0 auto; font-size:2.6em; text-decoration: underline;
    text-shadow:-2px -2px 0 black,2px -2px 0 black,-2px 2px 0 black,2px 2px 0 black;
    display:inline-block; }
.top-caption{ margin-top:8px; color:#aaa; font-size:1em; }

.container{ max-width:1200px; margin: 60px auto 40px; padding: 0 20px; }

#emu-box{
    margin: 0 auto 16px;
    padding:20px;
    width:90%;
    max-width:600px;
    border:3px dashed #ccc;
    border-radius:10px;
    background-color:#222;
    position:relative;
    cursor:pointer;
    text-align:center;
}
#emu-box:hover{ border-color:var(--accent); background-color:#333; }
#input{ position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer; }

#game{
    margin:18px auto 0;
    width:60%;
    max-width:920px;
    height:480px;
    background:black;
    border:3px solid;
    border-image: var(--border-grad);
    display:flex;
    align-items:center;
    justify-content:center;
    color:#777;
    font-weight:600;
}

.caption-legal{ font-size:1em; color:#aaa; margin-top:8px; text-align:center; }
.info{ margin:24px auto; width:75%; color:rgba(255,255,255,0.95); background: rgba(0,0,0,0.45); padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); }
.error{ color:#ffb3b3; }
a.btn { display:inline-block; margin-top:10px; padding:8px 12px; border-radius:8px; color:white; text-decoration:none; background:rgba(0,0,0,0.6); border:2px solid; border-image: var(--border-grad); }
</style>
</head>
<body>
<header>
<h1 class="page-title">Logi-PS2 (Play!.js)</h1>
<div class="top-caption">Only use PS2 images that you legally own. Powered by Play!.js (self-host build).</div>
</header>

<div class="container">
<p class="caption-legal" style="text-align:center;">
Drop a legally-owned PS2 image (ISO, CSO, CHD, BIN, ISZ, etc.) — the emulator runs locally in your browser.
</p>

<div id="emu-box">
<input type="file" id="input" accept=".iso,.cso,.chd,.isz,.bin,.img,.raw,.pbp">
Drag PS2 image here or click to choose
</div>

<div id="game">Play!.js not loaded yet.</div>

<div class="info" id="status">
<strong>Status:</strong> waiting for Play!.js files at <code>/static/images/playjs/</code>.
<div style="margin-top:8px">
<a class="btn" href="index.html">← Back to Logi Play</a>
<a class="btn" href="https://playjs.purei.org/" target="_blank" rel="noopener">Open official Play!.js site</a>
</div>
</div>
</div>

<script>
const PLAYJS_BASE = '/static/images/playjs/';
const PLAYJS_JS = PLAYJS_BASE + 'Play.js';
const PLAYJS_WASM = PLAYJS_BASE + 'Play.wasm';

const input = document.getElementById('input');
const statusEl = document.getElementById('status');
const gameEl = document.getElementById('game');

function setStatus(txt, isError=false){
    statusEl.innerHTML = `<strong>Status:</strong> ${txt}`;
    statusEl.classList.toggle('error', !!isError);
    console.log('Play!.js status:', txt);
}

// Load Play.js runtime
async function loadPlayJS() {
    setStatus('Loading Play.js...');
    window.Module = window.Module || {};
    window.Module.locateFile = (path) => path.endsWith('.wasm') ? PLAYJS_WASM : PLAYJS_BASE + path;
    window.Module.print = console.log;
    window.Module.printErr = console.error;

    await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = PLAYJS_JS;
        s.onload = resolve;
        s.onerror = () => reject(new Error('Failed to load Play.js'));
        document.body.appendChild(s);
    });

    if(typeof window.Module.onRuntimeInitialized === 'function'){
        await new Promise(res => {
            const orig = window.Module.onRuntimeInitialized;
            window.Module.onRuntimeInitialized = function(){
                try{ orig(); } catch(e){}
                res();
            }
        });
    } else {
        await new Promise(r => setTimeout(r, 700));
    }

    setStatus('Play.js runtime initialized. Drop a PS2 image.');
    gameEl.textContent = 'Runtime ready. Drop a PS2 image to begin.';
}

// Load ISO file
function fileToUint8(file){
    return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = () => resolve(new Uint8Array(reader.result));
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
    });
}

// Run ISO in Play.js
async function runFile(file){
    try{
        setStatus('Loading file: ' + file.name);
        const data = await fileToUint8(file);
        if(!window.FS){
            setStatus('Play.js FS not ready', true);
            return;
        }

        const dir = '/roms';
        try { window.FS.mkdir(dir); } catch(e){}
        const path = dir + '/' + file.name;

        if(typeof window.FS.writeFile==='function'){
            window.FS.writeFile(path, data, {encoding:'binary'});
        } else if(typeof window.FS_createDataFile==='function'){
            window.FS_createDataFile(dir, file.name, data, true, true);
        } else {
            setStatus('No FS method found', true);
            return;
        }

        setStatus('File written to FS: ' + path);

        // Try Play.js default start function
        if(typeof window.runGame === 'function'){
            window.runGame(path);
        } else if(typeof window.Module.ccall === 'function'){
            window.Module.ccall('main', 'number', ['number','number'], [0,0]);
        }

        gameEl.textContent = 'Running: ' + file.name;

    } catch(err){
        console.error(err);
        setStatus('Error: ' + err.message, true);
    }
}

// Event listeners
input.addEventListener('change', e => { if(e.target.files[0]) runFile(e.target.files[0]); });
const box = document.getElementById('emu-box');
box.addEventListener('dragover', e => { e.preventDefault(); box.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#38f'; });
box.addEventListener('dragleave', e => { e.preventDefault(); box.style.borderColor = ''; });
box.addEventListener('drop', e => {
    e.preventDefault();
    box.style.borderColor = '';
    if(e.dataTransfer.files[0]) runFile(e.dataTransfer.files[0]);
});

// initialize
loadPlayJS().catch(err => { console.error(err); setStatus('Failed to load Play.js', true); gameEl.textContent='Play.js failed to load'; });
</script>
</body>
</html>
